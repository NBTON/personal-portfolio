// ===== GSAP INITIALIZATION =====
gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

// ===== CONFIGURATION =====
const config = {
  ease: "power3.out",
  duration: 1.2,
  stagger: 0.15
};

// Respect reduced motion preference
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// ===== UTILITY FUNCTIONS =====
function isTouchDevice() {
  return ('ontouchstart' in window) ||
    (navigator.maxTouchPoints > 0) ||
    (navigator.msMaxTouchPoints > 0);
}

// ===== CUSTOM CURSOR WITH GSAP =====
if (!isTouchDevice() && !prefersReducedMotion) {
  const cursor = document.createElement('div');
  cursor.className = 'cursor';
  cursor.style.opacity = '1';
  cursor.style.visibility = 'visible';
  cursor.style.display = 'block';
  document.body.appendChild(cursor);

  let mouseX = 0, mouseY = 0;
  let cursorX = 0, cursorY = 0;
  const speed = 0.15;

  // Track mouse position
  document.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
  });

  // GSAP ticker for smooth cursor animation
  gsap.ticker.add(() => {
    cursorX += (mouseX - cursorX) * speed;
    cursorY += (mouseY - cursorY) * speed;

    cursor.style.left = cursorX + 'px';
    cursor.style.top = cursorY + 'px';
  });

  // Enhanced hover effect with magnetic pull
  const interactiveElements = document.querySelectorAll('a, button, .btn, .skill-tag, .project-card, input, textarea, .panel-cta, .progress-dot');

  interactiveElements.forEach(element => {
    element.addEventListener('mouseenter', () => {
      gsap.to(cursor, {
        scale: 1.5,
        duration: 0.3,
        ease: "back.out(1.7)"
      });
      cursor.classList.add('hover');
    });

    element.addEventListener('mouseleave', () => {
      gsap.to(cursor, {
        scale: 1,
        duration: 0.3,
        ease: "power2.out"
      });
      cursor.classList.remove('hover');
    });

    // Magnetic effect - cursor follows element
    element.addEventListener('mousemove', (e) => {
      const rect = element.getBoundingClientRect();
      const x = e.clientX - rect.left - rect.width / 2;
      const y = e.clientY - rect.top - rect.height / 2;

      // Move element slightly toward cursor (magnetic effect)
      gsap.to(element, {
        x: x * 0.15,
        y: y * 0.15,
        duration: 0.4,
        ease: "power2.out"
      });
    });

    element.addEventListener('mouseleave', () => {
      gsap.to(element, {
        x: 0,
        y: 0,
        duration: 0.5,
        ease: "elastic.out(1, 0.5)"
      });
    });
  });

  // Hide cursor when leaving window
  document.addEventListener('mouseleave', () => {
    gsap.to(cursor, { opacity: 0, duration: 0.2 });
  });

  document.addEventListener('mouseenter', () => {
    gsap.to(cursor, { opacity: 1, duration: 0.2 });
  });
}

// Add touch-device class if needed
if (isTouchDevice()) {
  document.body.classList.add('touch-device');
}

// ===== HERO SECTION ANIMATIONS =====
function initHeroAnimations() {
  const heroTitle = document.querySelector('[data-hero-title]');
  const heroSubtitle = document.querySelector('[data-hero-subtitle]');
  const heroCTAs = document.querySelectorAll('.hero .btn');

  if (!prefersReducedMotion && heroTitle) {
    // Simple fade-in animation for hero name (no text splitting)
    const heroName = heroTitle.querySelector('.hero-name');
    if (heroName) {
      gsap.fromTo(heroName,
        { opacity: 0, y: 20 },
        { opacity: 1, y: 0, duration: 1, delay: 0.3, ease: "power3.out" }
      );
    }

    // Animate title text
    gsap.fromTo(heroTitle,
      { opacity: 0, y: 30 },
      { opacity: 1, y: 0, duration: 1, ease: config.ease }
    );

    // Animate subtitle
    gsap.from(heroSubtitle, {
      opacity: 0,
      y: 30,
      duration: 1,
      delay: 0.3,
      ease: config.ease
    });

    // Animate CTA buttons with stagger
    gsap.from(heroCTAs, {
      opacity: 0,
      y: 30,
      stagger: 0.15,
      duration: 0.8,
      delay: 0.6,
      ease: "back.out(1.4)"
    });
  }
}

// ===== SECTION HEADINGS =====
function initSectionHeadings() {
  const headings = document.querySelectorAll('[data-heading]');

  headings.forEach(heading => {
    if (!prefersReducedMotion) {
      gsap.from(heading, {
        scrollTrigger: {
          trigger: heading,
          start: "top 85%",
          toggleActions: "play none none none"
        },
        opacity: 0,
        y: 50,
        duration: 0.8,
        ease: config.ease
      });

      // Animate underline
      const underline = heading.querySelector('.section-underline');
      if (underline) {
        gsap.from(underline, {
          scrollTrigger: {
            trigger: heading,
            start: "top 85%",
            toggleActions: "play none none none"
          },
          width: 0,
          duration: 0.8,
          delay: 0.3,
          ease: "power2.out"
        });
      }
    }
  });
}

// ===== ABOUT SECTION =====
function initAboutSection() {
  const card = document.querySelector('[data-card]');
  const content = document.querySelector('[data-content]');
  const skills = document.querySelectorAll('[data-skill]');

  if (!prefersReducedMotion && card) {
    // Animate card entrance
    gsap.from(card, {
      scrollTrigger: {
        trigger: card,
        start: "top 80%",
        toggleActions: "play none none none"
      },
      opacity: 0,
      y: 60,
      scale: 0.95,
      duration: 1,
      ease: "back.out(1.2)"
    });

    // Animate content
    if (content) {
      const paragraphs = content.querySelectorAll('p, h3, h4');
      gsap.from(paragraphs, {
        scrollTrigger: {
          trigger: content,
          start: "top 75%",
          toggleActions: "play none none none"
        },
        opacity: 0,
        y: 30,
        stagger: 0.1,
        duration: 0.8,
        delay: 0.2,
        ease: config.ease
      });
    }

    // Animate skill tags with 3D effect
    if (skills.length > 0) {
      gsap.fromTo(skills,
        { opacity: 0, scale: 0, y: 20 },
        {
          scrollTrigger: {
            trigger: '[data-skills]',
            start: "top 85%",
            toggleActions: "play none none none"
          },
          opacity: 1,
          scale: 1,
          y: 0,
          stagger: {
            each: 0.08,
            from: "start"
          },
          duration: 0.6,
          delay: 0.2,
          ease: "back.out(1.7)"
        }
      );
    }

    // Hover 3D tilt effect for card
    if (!isTouchDevice()) {
      card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const rotateX = (y - centerY) / 20;
        const rotateY = (centerX - x) / 20;

        gsap.to(card, {
          rotationX: rotateX,
          rotationY: rotateY,
          duration: 0.5,
          ease: "power2.out"
        });
      });

      card.addEventListener('mouseleave', () => {
        gsap.to(card, {
          rotationX: 0,
          rotationY: 0,
          duration: 0.5,
          ease: "elastic.out(1, 0.5)"
        });
      });
    }
  }
}

// ===== EXPERIENCE TIMELINE =====
function initTimeline() {
  const timelineItems = document.querySelectorAll('[data-timeline-item]');
  const timeline = document.querySelector('[data-timeline]');

  if (!prefersReducedMotion && timelineItems.length > 0) {
    // Animate timeline line drawing
    if (timeline) {
      const timelineLine = timeline.querySelector('::before');
      gsap.from(timeline, {
        scrollTrigger: {
          trigger: timeline,
          start: "top 80%",
          end: "bottom 20%",
          scrub: 1
        },
        '--timeline-height': '0%'
      });
    }

    // Animate timeline items
    timelineItems.forEach((item, index) => {
      const isLeft = item.querySelector('.left');
      const direction = isLeft ? -60 : 60;

      gsap.from(item, {
        scrollTrigger: {
          trigger: item,
          start: "top 85%",
          toggleActions: "play none none none"
        },
        opacity: 0,
        x: direction,
        y: 30,
        duration: 0.8,
        delay: index * 0.1,
        ease: "back.out(1.4)"
      });

      // Pulse animation for timeline dot
      const dot = item.querySelector('.timeline-content::after');
      gsap.to(item, {
        scrollTrigger: {
          trigger: item,
          start: "top 80%",
          toggleActions: "play none none none"
        },
        onComplete: () => {
          gsap.to(item.querySelector('.timeline-content'), {
            '--dot-scale': 1.3,
            repeat: 2,
            yoyo: true,
            duration: 0.3,
            ease: "power2.inOut"
          });
        }
      });
    });
  }
}

// ===== CONTACT SECTION =====
function initContactSection() {
  const contactInfo = document.querySelector('[data-contact-info]');
  const form = document.querySelector('[data-form]');

  if (!prefersReducedMotion) {
    // Animate contact info
    if (contactInfo) {
      const links = contactInfo.querySelectorAll('.contact-link');
      gsap.from(links, {
        scrollTrigger: {
          trigger: contactInfo,
          start: "top 80%",
          toggleActions: "play none none none"
        },
        opacity: 0,
        x: -30,
        stagger: 0.1,
        duration: 0.6,
        ease: config.ease
      });
    }

    // Animate form fields
    if (form) {
      const formGroups = form.querySelectorAll('.form-group, button');
      gsap.from(formGroups, {
        scrollTrigger: {
          trigger: form,
          start: "top 80%",
          toggleActions: "play none none none"
        },
        opacity: 0,
        y: 30,
        stagger: 0.1,
        duration: 0.6,
        delay: 0.2,
        ease: config.ease
      });

      // Focus animation for inputs
      const inputs = form.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', () => {
          gsap.to(input, {
            scale: 1.02,
            boxShadow: "0 0 20px rgba(0, 187, 119, 0.3)",
            duration: 0.3,
            ease: "power2.out"
          });
        });

        input.addEventListener('blur', () => {
          gsap.to(input, {
            scale: 1,
            boxShadow: "none",
            duration: 0.3,
            ease: "power2.out"
          });
        });
      });
    }
  }
}

// ===== PROJECT SHOWCASE ENHANCEMENTS =====
function initProjectShowcase() {
  const showcase = document.querySelector('.projects-showcase');
  const panels = document.querySelectorAll('.project-panel');
  const progressDots = document.querySelectorAll('.progress-dot');
  const progressContainer = document.getElementById('showcaseProgress');
  const scrollHint = document.getElementById('scrollHint');

  if (!showcase || panels.length === 0) return;

  const totalPanels = panels.length;
  let currentIndex = 0;

  // Add parallax effect to project images
  if (!prefersReducedMotion) {
    panels.forEach(panel => {
      const panelImage = panel.querySelector('.panel-image');
      if (panelImage) {
        gsap.to(panelImage, {
          scrollTrigger: {
            trigger: panel,
            start: "top bottom",
            end: "bottom top",
            scrub: 1
          },
          y: -30,
          ease: "none"
        });
      }
    });
  }

  // Calculate section boundaries
  function updatePanelVisibility() {
    const showcaseRect = showcase.getBoundingClientRect();
    const showcaseTop = showcaseRect.top;
    const showcaseHeight = showcaseRect.height;
    const viewportHeight = window.innerHeight;

    const isInView = showcaseTop < viewportHeight && (showcaseTop + showcaseHeight) > 0;

    if (isInView) {
      progressContainer.classList.add('visible');

      const scrollProgress = Math.max(0, -showcaseTop) / (showcaseHeight - viewportHeight);
      const panelIndex = Math.min(
        Math.floor(scrollProgress * totalPanels),
        totalPanels - 1
      );

      if (panelIndex > 0) {
        scrollHint.classList.remove('visible');
      } else {
        scrollHint.classList.add('visible');
      }

      if (panelIndex !== currentIndex && panelIndex >= 0 && panelIndex < totalPanels) {
        setActivePanel(panelIndex);
      }
    } else {
      progressContainer.classList.remove('visible');
      scrollHint.classList.remove('visible');
    }
  }

  function setActivePanel(index) {
    panels.forEach((panel, i) => {
      if (i === index) {
        panel.classList.add('active');
      } else {
        panel.classList.remove('active');
      }
    });

    progressDots.forEach((dot, i) => {
      if (i === index) {
        dot.classList.add('active');
        if (!prefersReducedMotion) {
          gsap.from(dot, {
            scale: 0.8,
            duration: 0.3,
            ease: "back.out(1.7)"
          });
        }
      } else {
        dot.classList.remove('active');
      }
    });

    currentIndex = index;
  }

  // Click handler for progress dots
  progressDots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      const showcaseRect = showcase.getBoundingClientRect();
      const showcaseTop = window.pageYOffset + showcaseRect.top;
      const showcaseScrollHeight = showcase.offsetHeight - window.innerHeight;
      const targetScroll = showcaseTop + (index / (totalPanels - 1)) * showcaseScrollHeight;

      gsap.to(window, {
        scrollTo: targetScroll,
        duration: 1,
        ease: "power2.inOut"
      });
    });
  });

  // Throttled scroll handler
  let ticking = false;
  function onScroll() {
    if (!ticking) {
      requestAnimationFrame(() => {
        updatePanelVisibility();
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', updatePanelVisibility);

  updatePanelVisibility();
  setActivePanel(0);
}

// ===== MOBILE NAVIGATION =====
const hamburger = document.querySelector('.hamburger');
const mobileNav = document.querySelector('.mobile-nav');
const mobileOverlay = document.querySelector('.mobile-nav-overlay');
const closeMenu = document.querySelector('.close-menu');

hamburger.addEventListener('click', () => {
  hamburger.classList.toggle('active');
  mobileNav.classList.add('active');
  mobileOverlay.classList.add('active');
  document.body.style.overflow = 'hidden';

  if (!prefersReducedMotion) {
    const navLinks = mobileNav.querySelectorAll('.mobile-nav-links a');
    gsap.from(navLinks, {
      opacity: 0,
      x: -30,
      stagger: 0.1,
      duration: 0.4,
      ease: "power2.out"
    });
  }
});

function closeMobileMenu() {
  hamburger.classList.remove('active');
  mobileNav.classList.remove('active');
  mobileOverlay.classList.remove('active');
  document.body.style.overflow = '';
}

closeMenu.addEventListener('click', closeMobileMenu);
mobileOverlay.addEventListener('click', closeMobileMenu);

// ===== SMOOTH SCROLLING =====
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();

    if (mobileNav.classList.contains('active')) {
      closeMobileMenu();
    }

    const targetId = this.getAttribute('href');
    const targetElement = document.querySelector(targetId);

    if (targetElement) {
      const offset = 80;
      const targetPosition = targetElement.offsetTop - offset;

      gsap.to(window, {
        scrollTo: {
          y: targetPosition,
          autoKill: false
        },
        duration: 1,
        ease: "power2.inOut"
      });
    }
  });
});

// ===== CONTACT FORM =====
document.getElementById('contactForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;
  const message = document.getElementById('message').value;

  const mailtoLink = `mailto:omar.aalsharani@gmail.com?subject=Portfolio Contact: ${encodeURIComponent(name)}&body=${encodeURIComponent(`Name: ${name}\\nEmail: ${email}\\n\\nMessage:\\n${message}`)}`;

  window.location.href = mailtoLink;

  // Animated notification
  const notification = document.getElementById('notification');
  if (!prefersReducedMotion) {
    gsap.fromTo(notification,
      { opacity: 0, y: 20, scale: 0.8 },
      {
        opacity: 1,
        y: 0,
        scale: 1,
        duration: 0.5,
        ease: "back.out(1.7)",
        onComplete: () => {
          gsap.to(notification, {
            opacity: 0,
            y: 20,
            delay: 2.5,
            duration: 0.3,
            ease: "power2.in"
          });
        }
      }
    );
  } else {
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3000);
  }

  this.reset();
});

// ===== PORTFOLIO BUTTON =====
const portfolioBtn = document.getElementById('portfolioViewProjectBtn');
if (portfolioBtn) {
  portfolioBtn.addEventListener('click', function (e) {
    e.preventDefault();
    gsap.to(window, {
      scrollTo: 0,
      duration: 1.5,
      ease: "power2.inOut"
    });
  });
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
  // Initialize all animations
  initHeroAnimations();
  initSectionHeadings();
  initAboutSection();
  initTimeline();
  initContactSection();
  initProjectShowcase();

  // Scroll reveal for generic sections
  gsap.utils.toArray('[data-section]').forEach(section => {
    if (!prefersReducedMotion) {
      gsap.from(section, {
        scrollTrigger: {
          trigger: section,
          start: "top 90%",
          toggleActions: "play none none none"
        },
        opacity: 0,
        y: 50,
        duration: 1,
        ease: config.ease
      });
    }
  });

  console.log('ðŸš€ GSAP Portfolio animations initialized!');
});
